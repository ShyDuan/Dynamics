function qbar = C2Q(C)

c11=C(1,1);  c12=C(1,2);  c13=C(1,3);   
c21=C(2,1);  c22=C(2,2);  c23=C(2,3);
c31=C(3,1);  c32=C(3,2);  c33=C(3,3);
   
if c11+c22+c33+1>=0.004
    q4=sqrt(c11+c22+c33+1)/2;
    q1=(c23-c32)/(4*q4);
    q2=(c31-c13)/(4*q4);
    q3=(c12-c21)/(4*q4);
elseif c11+c22+c33+1<0.004 && 1-c11+c22-c33>=0.004
    q2=sqrt(1-c11+c22-c33)/2*sign(c31-c13);
    q1=(c21+c12)/(4*q2);
    q3=(c32+c23)/(4*q2);
    q4=(c31-c13)/(4*q2);
elseif c11+c22+c33+1<0.004 && 1-c11+c22-c33<0.004 && 1+c11-c22-c33>=0.004
    q1=sqrt(1+c11-c22-c33)/2*sign(c23-c32);
    q2=(c21+c12)/(4*q1);
    q3=(c13+c31)/(4*q1);
    q4=(c23-c32)/(4*q1);
else
    q3=sqrt(1-c11-c22+c33)/2*sign(c12-c21);
    q1=(c13+c31)/(4*q3);
    q2=(c23+c32)/(4*q3);
    q4=(c12-c21)/(4*q3);
end
qbar = [q1;q2;q3;q4]/norm([q1;q2;q3;q4]);
if qbar(4)<0; qbar(4)=-qbar(4);end